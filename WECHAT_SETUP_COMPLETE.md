# âœ… å¾®ä¿¡ç™»å½•é…ç½®å®ŒæˆæŒ‡å—

## ðŸŽ‰ å·²é…ç½®ä¿¡æ¯

- âœ… å…¬ä¼—å·ï¼šäº‘èµ› ArcX
- âœ… AppID: `wx78427a667a2ca948`
- âœ… AppSecret: `67017e32df837f1fbf68d6eb488d9c87`
- âœ… æ”¯æŒï¼šPCæ‰«ç  + æ‰‹æœºå¾®ä¿¡å†…ç™»å½•

---

## ðŸš€ ç«‹å³å¯åŠ¨æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶

åœ¨ `tournament-frontend` ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```bash
cd tournament-frontend
cat > .env.local << 'EOF'
# å¾®ä¿¡å…¬ä¼—å·é…ç½®
VITE_WECHAT_APPID=wx78427a667a2ca948
VITE_WECHAT_APPSECRET=67017e32df837f1fbf68d6eb488d9c87

# PocketBase é…ç½®
VITE_POCKETBASE_URL=http://127.0.0.1:8090
VITE_API_URL=http://127.0.0.1:8090/api

# åº”ç”¨é…ç½®
VITE_APP_URL=http://localhost:5173
EOF
```

### æ­¥éª¤ 2: å®‰è£…å‰ç«¯ä¾èµ–

```bash
npm install @ant-design/icons
```

### æ­¥éª¤ 3: é…ç½® PocketBase users é›†åˆ

1. æ‰“å¼€ PocketBase Admin: http://127.0.0.1:8090/_/
2. è¿›å…¥ `users` é›†åˆ
3. ç‚¹å‡» "Fields" æ ‡ç­¾
4. æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå | ç±»åž‹ | Required | Unique | è¯´æ˜Ž |
|--------|------|----------|--------|------|
| wechatOpenid | Text | No | Yes | å¾®ä¿¡OpenID |
| wechatUnionid | Text | No | No | å¾®ä¿¡UnionID |
| avatar | URL | No | No | ç”¨æˆ·å¤´åƒ |

5. ä¿å­˜é›†åˆ

### æ­¥éª¤ 4: é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°

1. **ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°**: https://mp.weixin.qq.com/
2. **è®¾ç½®ç½‘é¡µæŽˆæƒåŸŸå**:
   - å·¦ä¾§èœå•ï¼šè®¾ç½®ä¸Žå¼€å‘ â†’ å…¬ä¼—å·è®¾ç½® â†’ åŠŸèƒ½è®¾ç½®
   - ç½‘é¡µæŽˆæƒåŸŸåï¼šæ·»åŠ  `localhost`ï¼ˆå¼€å‘ï¼‰å’Œä½ çš„åŸŸåï¼ˆç”Ÿäº§ï¼‰
   - ä¸‹è½½éªŒè¯æ–‡ä»¶æ”¾åˆ°é¡¹ç›®æ ¹ç›®å½•

3. **é…ç½®JSæŽ¥å£å®‰å…¨åŸŸå**ï¼ˆå¯é€‰ï¼Œç”¨äºŽæ›´å¥½çš„ä½“éªŒï¼‰:
   - åŒæ ·çš„ä½ç½®æ·»åŠ åŸŸå

### æ­¥éª¤ 5: é‡å¯æœåŠ¡

**ç»ˆç«¯ 1 - PocketBase:**
```bash
cd pocketbase
./pocketbase serve
```

**ç»ˆç«¯ 2 - å‰ç«¯:**
```bash
cd tournament-frontend
npm run dev
```

---

## ðŸ§ª æµ‹è¯•å¾®ä¿¡ç™»å½•

### PCç«¯æµ‹è¯•ï¼ˆæ‰«ç ç™»å½•ï¼‰:

1. æ‰“å¼€æµè§ˆå™¨ï¼šhttp://localhost:5173/login
2. ç‚¹å‡» **"ðŸŽ¯ ä½¿ç”¨å¾®ä¿¡ç™»å½•"**
3. æ˜¾ç¤ºäºŒç»´ç 
4. ç”¨æ‰‹æœºå¾®ä¿¡æ‰«ç 
5. åœ¨æ‰‹æœºä¸Šç‚¹å‡»"ç¡®è®¤ç™»å½•"
6. PCè‡ªåŠ¨è·³è½¬å¹¶ç™»å½•æˆåŠŸ âœ…

### æ‰‹æœºç«¯æµ‹è¯•ï¼ˆå¾®ä¿¡å†…ç½‘é¡µæŽˆæƒï¼‰:

1. åœ¨ç”µè„‘ä¸Šæ‰“å¼€ï¼šhttp://localhost:5173/login
2. ç”¨å¾®ä¿¡æ‰«æé¡µé¢äºŒç»´ç ï¼ˆæˆ–å¤åˆ¶é“¾æŽ¥å‘åˆ°å¾®ä¿¡ï¼‰
3. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€é“¾æŽ¥
4. ç‚¹å‡» **"ðŸŽ¯ ä½¿ç”¨å¾®ä¿¡ç™»å½•"**
5. è‡ªåŠ¨è·³è½¬åˆ°æŽˆæƒé¡µé¢
6. ç‚¹å‡»"å…è®¸"
7. è‡ªåŠ¨è¿”å›žå¹¶ç™»å½•æˆåŠŸ âœ…

---

## ðŸ“± ç”¨æˆ·ç™»å½•æµç¨‹

### åœºæ™¯ 1: PCæµè§ˆå™¨è®¿é—®
```
ç”¨æˆ·è®¿é—®ç½‘ç«™
  â†“
ç‚¹å‡»"ä½¿ç”¨å¾®ä¿¡ç™»å½•"
  â†“
æ˜¾ç¤ºäºŒç»´ç 
  â†“
ç”¨æˆ·æ‰«ç 
  â†“
æ‰‹æœºç¡®è®¤
  â†“
PCè‡ªåŠ¨ç™»å½• âœ…
```

### åœºæ™¯ 2: æ‰‹æœºå¾®ä¿¡å†…è®¿é—®
```
ç”¨æˆ·åœ¨å¾®ä¿¡æ‰“å¼€é“¾æŽ¥
  â†“
ç‚¹å‡»"ä½¿ç”¨å¾®ä¿¡ç™»å½•"
  â†“
è·³è½¬å¾®ä¿¡æŽˆæƒé¡µ
  â†“
ç‚¹å‡»"å…è®¸"
  â†“
è‡ªåŠ¨ç™»å½• âœ…
```

### åœºæ™¯ 3: æ‰‹æœºæµè§ˆå™¨ï¼ˆéžå¾®ä¿¡ï¼‰
```
ç”¨æˆ·è®¿é—®ç½‘ç«™
  â†“
ç‚¹å‡»"ä½¿ç”¨å¾®ä¿¡ç™»å½•"
  â†“
æç¤º"è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€"
  â†“
æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
```

---

## ðŸ” éªŒè¯é…ç½®

### æ£€æŸ¥ PocketBase Hook:
```bash
ls -la pocketbase/pb_hooks/wechat_auth.pb.js
```
åº”è¯¥çœ‹åˆ°æ–‡ä»¶å­˜åœ¨ âœ…

### æµ‹è¯•é…ç½®æŽ¥å£:
```bash
curl http://127.0.0.1:8090/api/auth/wechat/config
```
åº”è¯¥è¿”å›ž:
```json
{
  "appId": "wx78427a667a2ca948",
  "configured": true,
  "hasSecret": true
}
```

### æ£€æŸ¥å‰ç«¯çŽ¯å¢ƒå˜é‡:
æµè§ˆå™¨æŽ§åˆ¶å°è¿è¡Œï¼š
```javascript
console.log(import.meta.env.VITE_WECHAT_APPID)
```
åº”è¯¥æ˜¾ç¤º: `wx78427a667a2ca948` âœ…

---

## ðŸŽ¨ å·²æ·»åŠ çš„åŠŸèƒ½

### 1. ç™»å½•é¡µé¢æ›´æ–°
- âœ… æ·»åŠ ç»¿è‰²å¾®ä¿¡ç™»å½•æŒ‰é’®
- âœ… è‡ªåŠ¨æ£€æµ‹è®¾å¤‡ç±»åž‹
- âœ… åˆ†éš”çº¿ç¾ŽåŒ–

### 2. å¾®ä¿¡ç™»å½•é¡µé¢
- âœ… PCç«¯æ˜¾ç¤ºäºŒç»´ç 
- âœ… æ‰‹æœºå¾®ä¿¡å†…æ˜¾ç¤ºæŽˆæƒæŒ‰é’®
- âœ… æ‰‹æœºéžå¾®ä¿¡æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
- âœ… è‡ªåŠ¨é€‚é…ä¸åŒåœºæ™¯

### 3. å›žè°ƒå¤„ç†
- âœ… å¤„ç†å¾®ä¿¡è¿”å›žçš„code
- âœ… èŽ·å–ç”¨æˆ·ä¿¡æ¯
- âœ… è‡ªåŠ¨ç™»å½•/æ³¨å†Œ
- âœ… è·³è½¬åˆ°é¦–é¡µ

### 4. PocketBase åŽç«¯
- âœ… å¾®ä¿¡OAuthå¤„ç†
- âœ… ç”¨æˆ·è‡ªåŠ¨åˆ›å»º
- âœ… Tokenç”Ÿæˆ
- âœ… å®Œæ•´é”™è¯¯å¤„ç†

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. äºŒç»´ç ä¸æ˜¾ç¤º
**åŽŸå› **: å¾®ä¿¡SDKåŠ è½½å¤±è´¥

**è§£å†³**:
- æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
- æŸ¥çœ‹æµè§ˆå™¨æŽ§åˆ¶å°é”™è¯¯
- ç¡®è®¤AppIDæ­£ç¡®

### 2. "redirect_uri å‚æ•°é”™è¯¯"
**åŽŸå› **: å›žè°ƒåŸŸåæœªåœ¨å¾®ä¿¡å¹³å°é…ç½®

**è§£å†³**:
1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
2. è®¾ç½®ä¸Žå¼€å‘ â†’ å…¬ä¼—å·è®¾ç½® â†’ åŠŸèƒ½è®¾ç½®
3. ç½‘é¡µæŽˆæƒåŸŸåæ·»åŠ ï¼š`localhost`

### 3. "invalid code"
**åŽŸå› **: codeå·²è¢«ä½¿ç”¨æˆ–è¿‡æœŸ

**è§£å†³**:
- codeåªèƒ½ä½¿ç”¨ä¸€æ¬¡
- é‡æ–°æ‰«ç /æŽˆæƒå³å¯
- codeæœ‰æ•ˆæœŸ5åˆ†é’Ÿ

### 4. ç”¨æˆ·ä¿¡æ¯èŽ·å–å¤±è´¥
**åŽŸå› **: access_tokenå¤±æ•ˆæˆ–scopeä¸è¶³

**è§£å†³**:
- æ£€æŸ¥AppSecretæ˜¯å¦æ­£ç¡®
- ç¡®è®¤å…¬ä¼—å·å·²è®¤è¯ï¼ˆéœ€è¦è®¤è¯æ‰èƒ½èŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼‰

---

## ðŸ”’ å®‰å…¨æç¤º

### å·²å®žçŽ°çš„å®‰å…¨æŽªæ–½:

1. âœ… **Stateå‚æ•°** - é˜²æ­¢CSRFæ”»å‡»
2. âœ… **Tokenè®¤è¯** - PocketBase tokenæœºåˆ¶
3. âœ… **çŽ¯å¢ƒå˜é‡** - AppSecretä¸åœ¨ä»£ç ä¸­
4. âœ… **å”¯ä¸€çº¦æŸ** - OpenIDå”¯ä¸€ï¼Œé˜²æ­¢é‡å¤
5. âœ… **éšæœºå¯†ç ** - è‡ªåŠ¨ç”Ÿæˆå®‰å…¨å¯†ç 

### é¢å¤–å»ºè®®:

- âš ï¸ ä¸è¦å°† `.env.local` æäº¤åˆ° git
- âš ï¸ ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ HTTPS
- âš ï¸ å®šæœŸæ›´æ–° AppSecret
- âš ï¸ ç›‘æŽ§å¼‚å¸¸ç™»å½•è¡Œä¸º

---

## ðŸ“Š æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
  â†“
å‰ç«¯: wechatAuthService.loginWithWeChat()
  â†“
è·³è½¬å¾®ä¿¡æŽˆæƒé¡µé¢
  â†“
ç”¨æˆ·æŽˆæƒ
  â†“
å¾®ä¿¡å›žè°ƒ: /auth/wechat/callback?code=XXX&state=YYY
  â†“
å‰ç«¯: WeChatCallback.tsx
  â†“
è°ƒç”¨åŽç«¯: POST /api/auth/wechat/callback
  â†“
PocketBase Hook: wechat_auth.pb.js
  â”œâ”€ ç”¨codeæ¢access_token
  â”œâ”€ èŽ·å–ç”¨æˆ·ä¿¡æ¯
  â”œâ”€ æŸ¥æ‰¾/åˆ›å»ºç”¨æˆ·
  â””â”€ ç”Ÿæˆtoken
  â†“
è¿”å›žå‰ç«¯: token + user
  â†“
ä¿å­˜åˆ° PocketBase authStore
  â†“
è·³è½¬åˆ°é¦–é¡µ âœ…
```

---

## ðŸŽ¯ ç”Ÿäº§éƒ¨ç½²

### åŸŸåé…ç½®:

1. **åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°**æ·»åŠ ç”Ÿäº§åŸŸåï¼š
   ```
   yourdomain.com
   ```

2. **æ›´æ–° `.env.production`**:
   ```bash
   VITE_WECHAT_APPID=wx78427a667a2ca948
   VITE_WECHAT_APPSECRET=67017e32df837f1fbf68d6eb488d9c87
   VITE_POCKETBASE_URL=https://yourdomain.com
   VITE_APP_URL=https://yourdomain.com
   ```

3. **æž„å»ºç”Ÿäº§ç‰ˆæœ¬**:
   ```bash
   npm run build
   ```

4. **é…ç½®HTTPS** - å¾®ä¿¡è¦æ±‚æŽˆæƒå¿…é¡»ä½¿ç”¨HTTPS

---

## ðŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

### æ£€æŸ¥æ¸…å•:

- [ ] PocketBase æ­£åœ¨è¿è¡Œï¼ˆ8090ç«¯å£ï¼‰
- [ ] å‰ç«¯æ­£åœ¨è¿è¡Œï¼ˆ5173ç«¯å£ï¼‰
- [ ] `.env.local` æ–‡ä»¶å·²åˆ›å»º
- [ ] users é›†åˆå·²æ·»åŠ å¾®ä¿¡å­—æ®µ
- [ ] å¾®ä¿¡å…¬ä¼—å¹³å°å·²é…ç½®å›žè°ƒåŸŸå
- [ ] æµè§ˆå™¨å¯ä»¥è®¿é—® localhost:5173

### æŸ¥çœ‹æ—¥å¿—:

**PocketBaseæ—¥å¿—**:
```bash
tail -f pocketbase/pocketbase.log
```

**æµè§ˆå™¨æŽ§åˆ¶å°**: F12 æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

---

## âœ… å®ŒæˆçŠ¶æ€

- âœ… å‰ç«¯ä»£ç å®Œæˆ
- âœ… åŽç«¯Hookå®Œæˆ
- âœ… è·¯ç”±é…ç½®å®Œæˆ
- âœ… ç™»å½•æŒ‰é’®æ·»åŠ 
- âœ… çŽ¯å¢ƒå˜é‡æ¨¡æ¿
- âœ… æ–‡æ¡£å®Œæˆ

**ä¸€åˆ‡å°±ç»ªï¼çŽ°åœ¨å¯ä»¥æµ‹è¯•å¾®ä¿¡ç™»å½•äº†ï¼** ðŸŽŠ

---

## ðŸ“ž åŽç»­ä¼˜åŒ–å»ºè®®

1. **ç”¨æˆ·ä¿¡æ¯å®Œå–„**: ç™»å½•åŽå¼•å¯¼ç”¨æˆ·ç»‘å®šæ‰‹æœºå·/é‚®ç®±
2. **å¤´åƒæ˜¾ç¤º**: åœ¨ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºå¾®ä¿¡å¤´åƒ
3. **ä¸€é”®ç»‘å®š**: å…è®¸çŽ°æœ‰è´¦å·ç»‘å®šå¾®ä¿¡
4. **æ•°æ®ç»Ÿè®¡**: è®°å½•ç™»å½•æ¥æºå’Œæ—¶é—´
5. **é”™è¯¯æç¤º**: ä¼˜åŒ–å„ç§é”™è¯¯åœºæ™¯çš„ç”¨æˆ·æç¤º

éœ€è¦å®žçŽ°è¿™äº›åŠŸèƒ½å—ï¼Ÿå‘Šè¯‰æˆ‘ï¼ðŸš€

